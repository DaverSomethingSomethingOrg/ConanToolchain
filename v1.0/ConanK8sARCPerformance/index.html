<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://daversomethingsomethingorg.github.io/ConanToolchain/v1.0/ConanK8sARCPerformance/">
      
      
        <link rel="prev" href="../ConanK8sARCTroubleshooting/">
      
      
        <link rel="next" href="../LICENSE.txt">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Securing our GitHub ARC deployment and Making it Perform - Toolchain Build System using Conan</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#securing-our-github-arc-deployment-and-making-it-perform" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Toolchain Build System using Conan" class="md-header__button md-logo" aria-label="Toolchain Build System using Conan" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Toolchain Build System using Conan
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Securing our GitHub ARC deployment and Making it Perform
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/DaverSomethingSomethingOrg/ConanToolchain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Toolchain Build System using Conan" class="md-nav__button md-logo" aria-label="Toolchain Build System using Conan" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Toolchain Build System using Conan
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DaverSomethingSomethingOrg/ConanToolchain" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ButWhy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    But Why?
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SampleUsage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sample Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ConanRecipePreReqs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conan Setup and Recipe Pre-requisites
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../CIWorkflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CI Workflows
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../DemoGcc12MultiPhase/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Demo - MultiPhase GCC12 Compiler Bootstrap
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ConanZFSDemo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Demo - Optimizing C/C++ Build Performance using Conan and OpenZFS
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ConanK8sDevContainerDemo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Demo - Optimizing the Inner Loop with Conan and ZFS in Remote DevContainers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ConanK8sARCDemo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Demo - Conan and ZFS and Kubernetes CI (Oh my!)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ConanK8sARCTroubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting Conan ZFS GitHub ARC Container Initialization slowness
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Securing our GitHub ARC deployment and Making it Perform
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Securing our GitHub ARC deployment and Making it Perform
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment" class="md-nav__link">
    <span class="md-ellipsis">
      Environment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Environment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software" class="md-nav__link">
    <span class="md-ellipsis">
      Software
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-do-we-start" class="md-nav__link">
    <span class="md-ellipsis">
      Where Do We Start?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../LICENSE.txt" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache License v2.0
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment" class="md-nav__link">
    <span class="md-ellipsis">
      Environment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Environment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software" class="md-nav__link">
    <span class="md-ellipsis">
      Software
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-do-we-start" class="md-nav__link">
    <span class="md-ellipsis">
      Where Do We Start?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="securing-our-github-arc-deployment-and-making-it-perform">Securing our GitHub ARC deployment and Making it Perform<a class="headerlink" href="#securing-our-github-arc-deployment-and-making-it-perform" title="Permanent link">#</a></h1>
<!-- markdownlint-disable MD046 -->
<!-- markdownlint-disable MD034 -->

<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>Continuing our work with <a href="../ConanK8sARCDemo/">GitHub ARC with ZFS and Conan</a>.</p>
<p>We've deployed GitHub Actions Runner Controller (ARC) along with OpenEBS and
OpenZFS in order to optimize our CI and Developer Sandbox build performance.</p>
<div class="admonition note annotate">
<p class="admonition-title">GitHub ARC with ZFS and Conan</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/GitHubARCRunnerK8sContainerized.png" data-desc-position="bottom"><img alt="Conan and ZFS in GitHub ARC box diagram" src="../img/GitHubARCRunnerK8sContainerized.png"></a></p>
<p><em>Check out <a href="https://excalidraw.com/">Excalidraw</a> and their nifty diagramming tool!</em></p>
</div>
<p>This time we'll explore optimizing the Performance and Security of our GitHub
ARC deployment, now that our product build is optimized.</p>
<p>We'll also need to look at how it scales, and how it breaks.  How does cache
corruption spread though our clone structure?</p>
<h2 id="environment">Environment<a class="headerlink" href="#environment" title="Permanent link">#</a></h2>
<h3 id="hardware">Hardware<a class="headerlink" href="#hardware" title="Permanent link">#</a></h3>
<p>We'll be using the same hardware as our previous demos.  All performance
optimizations in this demo are done in the configuration, we're not doing
any hardware optimization.</p>
<ul>
<li>Server - AMD 8945HS/64GB/SSD</li>
<li>Workstation - AMD 9900X/32GB/SSD</li>
<li>Notebook - Macbook Pro M4 Pro</li>
<li>Network - Ubiquiti UniFi 2.5Gb/s Switch</li>
</ul>
<h3 id="software">Software<a class="headerlink" href="#software" title="Permanent link">#</a></h3>
<ul>
<li><a href="https://github.com/actions/actions-runner-controller/blob/master/README.md">GitHub Actions Runner Controller (ARC)</a></li>
<li><a href="https://openzfs.org/">OpenZFS</a> filesystem and storage platform</li>
<li><a href="https://openebs.io/">OpenEBS</a> with <a href="https://github.com/openebs/zfs-localpv/blob/develop/README.md">Local PV ZFS plugin</a></li>
<li><a href="https://conan.io/">Conan C/C++ Package Manager</a></li>
<li>Docker - <a href="https://github.com/DaverSomethingSomethingOrg/conan-toolchain-demo/tree/main/demos/gcc-toolchain/conan-build-container/README.md">ConanToolchain Docker Container Image</a></li>
<li><a href="https://www.sonatype.com/products/nexus-community-edition-download">Sonatype Nexus Community Edition</a></li>
</ul>
<h2 id="where-do-we-start">Where Do We Start?<a class="headerlink" href="#where-do-we-start" title="Permanent link">#</a></h2>
<p>GitHub Actions security is a well-known and explored topic already, but
we're somewhat new here.  While we could apply general security and
performance principles to improve our solution, thankfully we have help
available!  We can get a huge head-start by standing on the shoulders of
experts rather than reinventing this wheel from scratch.</p>
<p><a href="https://github.com/some-natalie">Natalie Somersall</a> has written an
excellent blog post on securing GitHub ARC already.  We won't try to
reiterate her entire post here, but we will try to honor her advice
by addressing each of her points and how it applies to our solution here.</p>
<div class="admonition tip annotate">
<p class="admonition-title">Further Reading</p>
<p>Somersall, Natalie (2023). 
<a href="https://some-natalie.dev/blog/securing-ghactions-with-arc/">Securing Self-Hosted GitHub Actions with Kubernetes and Actions-Runner-Controller</a></p>
<p>Also check out the rest of Natalie's quite-prolific blog site as well.
She has published many insightful articles on DevOps topics far beyond
just GitHub/ARC security.</p>
</div>
<h1 id="todo">TODO<a class="headerlink" href="#todo" title="Permanent link">#</a></h1>
<h2 id="general-performance">General Performance<a class="headerlink" href="#general-performance" title="Permanent link">#</a></h2>
<p>We want to look into other areas where we can improve performance of
our solution.  Performance is the primary goal of this project after all.</p>
<p>We'll look at the following areas for improvements:</p>
<ul>
<li>time to start new Runner</li>
<li>time for job to arrive at Runner</li>
<li>time to initialize workflow/$job container<ul>
<li>caching Actions themselves</li>
<li>caching Actions externals/dependencies</li>
</ul>
</li>
<li>time to start running job</li>
<li>time to cleanup after job</li>
</ul>
<h3 id="profiling-end-to-end-workflowjob-runtime">Profiling End-to-End workflow/job runtime<a class="headerlink" href="#profiling-end-to-end-workflowjob-runtime" title="Permanent link">#</a></h3>
<p>containerd logs
kubectl pod logs/events
observability setup</p>
<h3 id="instrumenting-the-github-arc-kubernetes-hook">Instrumenting the GitHub ARC kubernetes hook<a class="headerlink" href="#instrumenting-the-github-arc-kubernetes-hook" title="Permanent link">#</a></h3>
<ul>
<li>custom Runner container image for customized k8s hook</li>
<li>enhanced debugging</li>
<li>modified backoff schedule wastes less time sleeping</li>
<li>issues resolved</li>
</ul>
<h3 id="runner-caching-for-startup">Runner caching for startup<a class="headerlink" href="#runner-caching-for-startup" title="Permanent link">#</a></h3>
<ul>
<li>container image caching</li>
<li>seeding GitHub Runner externals</li>
<li>cp -R /home/runner/externals /home/runner/_work/externals</li>
<li>
<p>claims that copying externals can be slow, that's not the case here...virtually instantaneous</p>
<ul>
<li>probably related to using "local" storage for everything on a fast NVMe SSD</li>
</ul>
</li>
<li>
<p>waiting time seems to be entirely getting the pod from created/pending to running</p>
</li>
<li>
<p>seeding GitHub Runner actions downloading</p>
</li>
<li>
<p>backoff aggressive timing means we're sleeping longer than necessary</p>
</li>
<li>start with a more reasonable default wait time to avoid wasting the first backoff rounds</li>
<li>
<p>reduce backoff wait ratio from 2x to 1.25x</p>
</li>
<li>
<p>k8s-novolume?</p>
</li>
<li>is mounting the runner's work volume in the workflow container the problem?</li>
<li>k8s-novolume seems to have issues right now, not working.<ul>
<li>faster in general tho...</li>
</ul>
</li>
</ul>
<h3 id="workflow-job-container-optimization">Workflow job container optimization<a class="headerlink" href="#workflow-job-container-optimization" title="Permanent link">#</a></h3>
<ul>
<li>actions caching</li>
<li>
<p>/__w/_actions/action/name/version ~ /__w/_actions/action/actions/checkout/v4</p>
<ul>
<li>no .git subdir, just clean tag checkout</li>
</ul>
</li>
<li>
<p>confirmed that actions/checkout@v4 works fine mounted from ZFS cache, BUT...</p>
</li>
<li>
<p>Runner downloads actions prior to running hook and creating workflow container?</p>
<ul>
<li>if so we need to mount the actions cache to the runner as well as the workflow pod and make sure the actions are not downloaded anyway.</li>
<li>it can't slow down initializing the workflow container if the download is happening before the hook starts?</li>
</ul>
</li>
<li>still good idea for reliability (reduce external dependency at job runtime), general job starting, and supply chain security</li>
</ul>
<h3 id="kubectl-in-workflow-pod-initcontainer">kubectl in workflow pod initContainer?<a class="headerlink" href="#kubectl-in-workflow-pod-initcontainer" title="Permanent link">#</a></h3>
<h3 id="specifying-resource-requests-vs-limits">Specifying resource requests vs. limits<a class="headerlink" href="#specifying-resource-requests-vs-limits" title="Permanent link">#</a></h3>
<p>Does limiting resources start faster?</p>
<ul>
<li>Guaranteed Scheduling</li>
<li>Custom scheduling?</li>
</ul>
<h2 id="security">Security<a class="headerlink" href="#security" title="Permanent link">#</a></h2>
<p>Security is pretty well configured out of the box, but we'll review
common recommendations to make sure our solution still conforms, and
to take advantage of any features we've missed or mis0configured along
the way.</p>
<h3 id="shrink-wrapped-software-vs-saas">Shrink-wrapped software vs. SaaS<a class="headerlink" href="#shrink-wrapped-software-vs-saas" title="Permanent link">#</a></h3>
<h4 id="self-hosted-infrastructure-vs-cloud">Self-Hosted Infrastructure vs. Cloud<a class="headerlink" href="#self-hosted-infrastructure-vs-cloud" title="Permanent link">#</a></h4>
<ul>
<li>our Intellectual Property (source code) never has to leave our premises and direct control if we also self-host GitHub (with GHES - GitHub Enterprice Server) </li>
<li>runner container images are similarly protected<ul>
<li>older software or operating systems may have vulnerabilities that cannot be patched without affecting behavior negatively.</li>
<li>some industries (such as EDA) and deployments (such as embedded devices) may require use of older, more vulnerable operating systems for many years after OS support and maintenance have ended.  This is illustrated well by Microsoft's extended support for the Windows IoT releases but not the standard desktop/server releases.</li>
</ul>
</li>
</ul>
<p>For unmodified Open Source software, Cloud-hosted may be the more secure option.  Since it's not our software, we don't have to worry about IP theft.  In this case the vulnerability of the runner operating system is probably the more important consideration.</p>
<h3 id="container-image-optimization">Container Image Optimization<a class="headerlink" href="#container-image-optimization" title="Permanent link">#</a></h3>
<h4 id="minimal-images-with-common-base">Minimal images with common base<a class="headerlink" href="#minimal-images-with-common-base" title="Permanent link">#</a></h4>
<p>Rather than creating a container image that can do everything, we can structure our image
content in a way that allows all of our containers to be completely compatible with each
other, but still limited in content.</p>
<p>With a common base image and carefully curated artifact/package repositories, we can ensure that all container image package versions work together when installed, regardless of the image in use.
Then any language or workflow/job-specific images can be very minimal, while keeping the ability to interoperate with images for other jobs/workflows/languages.</p>
<h4 id="no-sudo-container-modification-at-runtime">No sudo / container modification at runtime<a class="headerlink" href="#no-sudo-container-modification-at-runtime" title="Permanent link">#</a></h4>
<p>This is both a security and a performance issue, but at the cost of maintenace.</p>
<p>Pre-installed (cached) software means no waiting for software install at runtime.  This gets jobs started much faster, ensures the complete container image can be completely pulled from the cache (local container registry) for each job.
This enhances security by allowing tighter permissions, removing the need for administratve access (at runtime).</p>
<p>The cost is maintenance.  Container images need to be up-to-date and available before the job starts.  If an
image update is missed, or not distributed in a timely fashion, it can lead to job failures or unpredictable results.</p>
<h4 id="image-distribution-and-caching">Image Distribution and Caching<a class="headerlink" href="#image-distribution-and-caching" title="Permanent link">#</a></h4>
<h4 id="developer-friction">Developer Friction<a class="headerlink" href="#developer-friction" title="Permanent link">#</a></h4>
<p>Now this is a controversial topic...</p>
<p>Locked down container images can slow down development.</p>
<p>When a developer is able to modify the workflow job container image at runtime, they can take responsibility for their own productivity and product needs.</p>
<p>When a workflow job can modify the image used,
it enables developers to try new tools, or different tool versions to suit their productivity or product performance/quality goals.</p>
<p>IMO the best approach is to provide the ability to modify the image, but only in an sandbox where the software available to install is limited.  Security vetted, cached on-premises, and tracked in your SCA (Software Composition Analysis) tooling.</p>
<p>This reduces the problem to ensuring any tools are required without the burden of ensuring all workflow job container images are updated and redistributed/seeded to the local caches.</p>
<h4 id="container-image-versioning">Container Image Versioning<a class="headerlink" href="#container-image-versioning" title="Permanent link">#</a></h4>
<ul>
<li>hardcoding semver for the image version vs. using a moving version tag such as "latest"</li>
</ul>
<p>uncontrolled content</p>
<h1 id="todo_1">TODO<a class="headerlink" href="#todo_1" title="Permanent link">#</a></h1>
<ul>
<li>Controller and RunnerScaleSet in different namespaces</li>
<li>Running as non-privileged user</li>
<li>securityContext</li>
<li>Runner container and job container need to have compatible securityContexts.</li>
<li>Runner container runs actions (including containerized Actions), so
  Runner container generally needs to ensure that all actions containers
  and job containers run as the same UID.</li>
<li>It doesn't work when the actions/checkout container clones the repo as
  root but the workflow/build container runs non-privileged internally.</li>
<li>non-privileged workflow pods</li>
<li>locking container versions away from latest</li>
<li>minimal container images<ul>
<li>minimal runner</li>
<li>minimal workflow</li>
</ul>
</li>
<li>no sudo in workflow</li>
<li>custom crafted workflow containers not modifyable by workflow</li>
<li>namespace vs. cluster isolation</li>
<li>dind-rootless</li>
<li>Links to GitHub ARC documentation on security best practices</li>
</ul>
<h2 id="performance-and-security-combined">Performance and Security combined<a class="headerlink" href="#performance-and-security-combined" title="Permanent link">#</a></h2>
<ul>
<li>Container/Kubernetes means not needing to chown the cache files for developer end use.</li>
<li>Importance of user-agnostic behavior</li>
<li>build is done "on behalf of" user, not executed directly by user account</li>
<li>generic, non-privileged userids own everything, run everything</li>
</ul>
<h2 id="troubleshooting-broken-builds">Troubleshooting Broken Builds<a class="headerlink" href="#troubleshooting-broken-builds" title="Permanent link">#</a></h2>
<p><code>ACTIONS_RUNNER_HOOK_JOB_COMPLETED</code> hook</p>
<p>To keep a container running indefinitely for debugging purposes, one common method involves overriding its entrypoint command to something like sleep infinity or tail -f /dev/null during setup, then using docker exec to interact with it. This is a manual debugging step, not an automated workflow configuration.</p>
<h2 id="limitations-and-open-issues">Limitations and Open Issues<a class="headerlink" href="#limitations-and-open-issues" title="Permanent link">#</a></h2>
<h2 id="whats-next">What's Next<a class="headerlink" href="#whats-next" title="Permanent link">#</a></h2>
<h3 id="deploy-solution-for-bazel-build-cache">Deploy solution for Bazel build cache<a class="headerlink" href="#deploy-solution-for-bazel-build-cache" title="Permanent link">#</a></h3>
<h3 id="supply-chain-dependency-track">Supply Chain - Dependency Track<a class="headerlink" href="#supply-chain-dependency-track" title="Permanent link">#</a></h3>
<h3 id="switch-to-netapp-instead-of-openzfs-and-openebs">Switch to NetApp instead of OpenZFS and OpenEBS?<a class="headerlink" href="#switch-to-netapp-instead-of-openzfs-and-openebs" title="Permanent link">#</a></h3>
<p>OpenZFS is great for prototyping and use on developer workstations, but
practically speaking it seems more likely that development environments
needing this level of build optimization probably have enterprise-grade
storage options available.</p>
<p>NetApp ONTAP with FlexClone is a more likely to be available in an
enterprise software development environment than OpenZFS.  It's also a
natural fit for this solution with it's patented snapshot and clone
technologies.</p>
<p>We should evaluate how well FlexClone fits into this solution.  Up until
this point we have been focusing on leveraging "free"/open technologies.</p>
<h2 id="conclusions">Conclusions<a class="headerlink" href="#conclusions" title="Permanent link">#</a></h2>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">#</a></h2>
<ul>
<li>
<p>Somersall, Natalie; <a href="https://some-natalie.dev/blog/securing-ghactions-with-arc/">Securing Self-Hosted GitHub Actions with Kubernetes and Actions-Runner-Controller</a></p>
</li>
<li>
<p>Harsh, Kumar; <a href="https://upcloud.com/resources/tutorials/supercharge-your-ci-cd-deploy-lightning-fast-github-actions-runners-on-upclouds-managed-kubernetes-part-2/">Supercharge Your CI/CD: Deploy Lightning-Fast GitHub Actions Runners on UpCloud’s Managed Kubernetes: Part 2</a></p>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../ConanK8sARCTroubleshooting/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Troubleshooting Conan ZFS GitHub ARC Container Initialization slowness">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Troubleshooting Conan ZFS GitHub ARC Container Initialization slowness
              </div>
            </div>
          </a>
        
        
          
          <a href="../LICENSE.txt" class="md-footer__link md-footer__link--next" aria-label="Next: Apache License v2.0">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Apache License v2.0
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2025, David L. Armstrong.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "content.code.annotate", "navigation.footer"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>